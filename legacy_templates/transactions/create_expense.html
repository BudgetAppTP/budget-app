<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BudgetApp ¬∑ Vydavky</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style_expense.css') }}">

</head>
<body>
{% block head_extra %}
{% endblock %}

{% block content %}
{% include "navbar.html" %}
<div class="wrap">
  <div class="page-title">
    üí∏ V√Ωdavky
    <div class="gold-line"></div>
  </div>

  <div class="summary">
    <span class="label">Spolu tento mesiac:</span>
    <span class="value" id="total-value">{{ "%.2f"|format(total_amount) }} ‚Ç¨</span>
  </div>

  <div class="table-card">
    <table>
      <thead>
      <tr>
        <th>D√°tum</th>
        <th>Kateg√≥ria</th>
        <th style="text-align:right;">Suma (‚Ç¨)</th>
        <th>Akcie</th>
      </tr>
      </thead>
      <tbody>
      {% for exp in expenses %}
      <tr data-id="{{ exp.id }}">
        <td contenteditable="false">{{ exp.date }}</td>
        <td data-type="category">{{ exp.category }}</td>
        <td class="amount" contenteditable="false">{{ "%.2f"|format(exp.amount) }}</td>
        <td class="actions">
          <span class="action-icon edit">‚úèÔ∏è</span>
          <span class="action-icon delete">üóëÔ∏è</span>
        </td>
      </tr>
      {% endfor %}
      </tbody>
      <tfoot>
      <tr>
        <td colspan="2">Spolu</td>
        <td class="amount" id="total-footer">{{ "%.2f"|format(total_amount) }}</td>
        <td></td>
      </tr>
      </tfoot>
    </table>
  </div>

  <form class="form-row">
    {{ form.hidden_tag() }}
    {{ form.date(required=True) }}

    <div id="category-wrapper">
      <select name="category" id="category-select" required>
        {% for cat in categories %}
        <option value="{{ cat }}">{{ cat }}</option>
        {% endfor %}
        <option value="add-new">‚ûï Prida≈• nov√∫ kateg√≥riu</option>
      </select>
    </div>

    {{ form.amount(step="0.01", inputmode="decimal", placeholder="Suma (‚Ç¨)", required=True) }}
    <button class="btn" type="submit">+ Prida≈• v√Ωdavok</button>
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
        const today = new Date();
  const dateBadge = document.getElementById('dateBadge');

  if (dateBadge) {
    dateBadge.innerHTML = `
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
           xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M7 2v3M17 2v3M3.5 9.5h17M4 6.5h16a1.5 1.5 0 0 1 1.5 1.5v11A1.5 1.5 0 0 1 20 20.5H4A1.5 1.5 0 0 1 2.5 19V8A1.5 1.5 0 0 1 4 6.5Z"
              stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <span>${today.toLocaleDateString('sk-SK', {
        year: 'numeric',
        month: 'long',
        day: '2-digit'
      })}</span>
    `;
  }


    const tbody = document.querySelector("tbody");
    const form = document.querySelector("form.form-row");
    let categories = {{ categories | tojson }};

    const wrapper = document.getElementById("category-wrapper");
    const select = document.getElementById("category-select");
    select.addEventListener("change", function() {
      if (this.value === "add-new") {
        wrapper.innerHTML = `
          <div class="custom-cat">
            <input type="text" id="new-cat" placeholder="Nov√° kateg√≥ria" required>
            <button type="button" id="confirm-cat" class="check-btn">‚úî</button>
          </div>
        `;
        document.getElementById("confirm-cat").addEventListener("click", () => {
          const val = document.getElementById("new-cat").value.trim();
          if (val) {
            categories.push(val);
            wrapper.innerHTML = `
              <select name="category" id="category-select" required>
                ${categories.map(c => `<option ${c===val?"selected":""}>${c}</option>`).join("")}
                <option value="add-new">‚ûï Prida≈• nov√∫ kateg√≥riu</option>
              </select>
            `;
          }
        });
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const csrfInput = document.querySelector('input[name="csrf_token"]');
      const csrfToken = csrfInput ? csrfInput.value : "";

      const date = form.querySelector('input[name="date"]')?.value?.trim();
      const catSelect = form.querySelector('#category-select');
      const category = catSelect ? catSelect.value.trim() : '';
      const amountValue = form.querySelector('input[name="amount"]')?.value?.trim();
      const amount = parseFloat(amountValue.replace(",", "."));

      if (!date || !category || isNaN(amount)) {
        alert("Vypl≈àte v≈°etky polia!");
        return;
      }

      const payload = { date, category, amount };

      try {
        const res = await fetch("/transactions/expenses/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "X-CSRFToken": csrfToken
          },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const text = await res.text();
          alert("Chyba pri ukladan√≠ v√Ωdavku!\n" + text);
          return;
        }

        const newExpense = await res.json();

        const tr = document.createElement("tr");
        tr.dataset.id = newExpense.id;
        tr.innerHTML = `
          <td contenteditable="false">${newExpense.date}</td>
          <td data-type="category">${newExpense.category}</td>
          <td class="amount" contenteditable="false">${newExpense.amount.toFixed(2)}</td>
          <td class="actions">
            <span class="action-icon edit">‚úèÔ∏è</span>
            <span class="action-icon delete">üóëÔ∏è</span>
          </td>
        `;
        tbody.appendChild(tr);
        updateTotal();

        form.reset();
      } catch (err) {
        alert("Chyba spojenia so serverom!");
      }
    });

    tbody.addEventListener("click", async (e) => {
      const tr = e.target.closest("tr");
      const id = tr?.dataset.id;
      if (!id) return;

      if (e.target.classList.contains("delete")) {
        await fetch(`/transactions/expenses/delete/${id}`, { method: "DELETE" });
        tr.remove();
        updateTotal();
        return;
      }

      if (e.target.classList.contains("edit")) {
        const isEditing = !tr.classList.contains("editing");
        const editBtn = e.target;
        const tds = tr.querySelectorAll("td");

        if (isEditing) {
          tr.classList.add("editing");
          tr.style.backgroundColor = "#fff8e1";
          tr.style.boxShadow = "inset 0 0 0 2px #d4a017";
          editBtn.textContent = "‚úî";

          tds[0].contentEditable = true;
          tds[2].contentEditable = true;

          const catTd = tds[1];
          const currentCat = catTd.textContent.trim();
          const select = document.createElement("select");
          select.innerHTML = categories.map(c =>
                  `<option value="${c}" ${c === currentCat ? "selected" : ""}>${c}</option>`
          ).join("") + '<option value="add-new">‚ûï Nov√° kateg√≥ria</option>';
          catTd.textContent = "";
          catTd.appendChild(select);

          select.addEventListener("change", () => {
            if (select.value === "add-new") {
              catTd.innerHTML = `
                <div class="custom-cat">
                  <input type="text" id="temp-cat" placeholder="Nov√° kateg√≥ria" style="width:90px">
                  <button type="button" class="check-btn">‚úî</button>
                </div>
              `;
              const input = catTd.querySelector("#temp-cat");
              const btn = catTd.querySelector(".check-btn");
              btn.addEventListener("click", () => {
                const val = input.value.trim();
                if (val) {
                  categories.push(val);
                  catTd.textContent = val;
                }
              });
            }
          });
        } else {
          tr.classList.remove("editing");
          tr.style.backgroundColor = "";
          tr.style.boxShadow = "";
          editBtn.textContent = "‚úèÔ∏è";

          const catTd = tds[1];
          const newCat = catTd.querySelector("select")?.value || catTd.textContent.trim();
          catTd.textContent = newCat;

          const data = {
            date: tds[0].textContent.trim(),
            category: newCat,
            amount: parseFloat(tds[2].textContent),
          };

          await fetch(`/transactions/expenses/edit/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          updateTotal();
        }
      }
    });

    function updateTotal() {
      let sum = 0;
      tbody.querySelectorAll(".amount").forEach(td => sum += parseFloat(td.textContent) || 0);
      document.getElementById("total-footer").textContent = sum.toFixed(2);
      document.getElementById("total-value").textContent = sum.toFixed(2) + " ‚Ç¨";
    }
  });
</script>
{% endblock %}
</body>
</html>