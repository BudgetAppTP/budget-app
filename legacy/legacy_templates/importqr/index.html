<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8">
  <title>Import QR / eKasa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <ul>
      {% for cat,msg in messages %}
        <li>{{ msg }}</li>
      {% endfor %}
    </ul>
  {% endif %}
  {% endwith %}

  <h1>Import QR / eKasa</h1>

  <form method="post" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    <div>
      <label for="{{ form.file.id }}">Subor s JSON</label>
      {{ form.file() }}
    </div>
    <div>
      <label for="{{ form.payload.id }}">JSON vstup</label>
      {{ form.payload(rows=8, cols=80, placeholder='[{"OPD":"...","date":"2025-10-12","category":"Jedlo","item":"Chlieb","qnt":1,"price":1.2,"vat":0.2,"seller":"Obchod","unit":"ks"}]') }}
    </div>
    <div>
      {{ form.submit_preview() }}
      {{ form.submit_confirm() }}
    </div>
  </form>

  {% if parsed is not none %}
    <h2>Nahlad poloziek</h2>
    {% if parsed %}
      <table border="1" cellpadding="6" cellspacing="0">
        <thead>
          <tr>
            <th>OPD</th>
            <th>Datum</th>
            <th>Kategoria</th>
            <th>Polozka</th>
            <th>Mnozstvo</th>
            <th>Jedn. cena</th>
            <th>DPH</th>
            <th>Predajca</th>
            <th>Jednotka</th>
            <th>Overenie</th>
          </tr>
        </thead>
        <tbody>
          {% for it in parsed %}
            <tr>
              <td>{{ it.opd }}</td>
              <td>{{ it.date }}</td>
              <td>{{ it.category }}</td>
              <td>{{ it.item }}</td>
              <td>{{ it.qnt }}</td>
              <td>{{ it.price }}</td>
              <td>{{ it.vat }}</td>
              <td>{{ it.seller }}</td>
              <td>{{ it.unit }}</td>
              <td>{{ it.valid and "OK" or "NEPLATI" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <form method="post">
        {{ form.hidden_tag() }}
        <input type="hidden" name="payload" value='{{ parsed|tojson }}'>
        {{ form.submit_confirm() }}
      </form>
    {% else %}
      <p>Ziadne polozky na zobrazenie.</p>
    {% endif %}
  {% endif %}
</body>
</html>
