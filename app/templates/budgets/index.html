{% block content %}
{% block head_extra %}
<style>

  .actions button {
    border: none;
    background: none;
    font-size: 18px;
    cursor: pointer;
    transition: transform 0.2s ease, opacity 0.2s ease;
  }

  .actions button:hover {
    transform: scale(1.2);
    opacity: 0.7;
  }

  .add-form {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: flex-start;
    margin-top: 12px;
    background: var(--white);
    padding: 10px;
    border-top: 2px solid var(--border);
  }

  .add-form input {
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 6px 8px;
    flex: 1;
  }

  .add-btn {
    background: var(--gold);
    border: none;
    border-radius: 6px;
    color: #111;
    font-weight: 600;
    padding: 6px 14px;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .add-btn:hover {
    background: var(--gold-dark);
  }



  :root {
    --bg: #ececec;
    --white: #ffffff;
    --border: #bfc2c7;
    --text: #111;
    --gold: #d4a017;
    --pastel-1: #f0ebf4;
    --pastel-2: #e7f1e8;
    --pastel-3: #f5e6e8;
    --pastel-4: #e4ecf5;
    --pastel-5: #f8f3e6;
    --pastel-6: #f1f4ec;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: "Inter", sans-serif;
    margin: 0;
    padding: 0;
  }

  .wrap {
    max-width: 1100px;
    margin: 40px auto;
    padding: 0 20px;
  }

  .page-header h2 {
    font-weight: 700;
    font-size: 26px;
    border-bottom: 3px solid var(--gold);
    padding-bottom: 6px;
    margin-bottom: 20px;
  }

  .summary-box {
    background: var(--white);
    padding: 12px 18px;
    border-left: 5px solid var(--gold);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    margin-bottom: 30px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  }

  .cards-grid {
    display: flex;
    justify-content: space-between;
    gap: 25px;
    flex-wrap: wrap;
    margin-bottom: 40px;
  }

  .budget-card {
    flex: 1 1 calc(25% - 25px);
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    text-align: center;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .budget-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  }

  .budget-card .header {
    font-weight: 600;
    font-size: 17px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }

  .content-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 10px;
    font-size: 16px;
    font-weight: 600;
  }

  .percent-input {
    width: 55px;
    padding: 4px;
    text-align: right;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: #fff;
  }

  .amount {
    border-left: 2px solid var(--border);
    padding-left: 8px;
    font-weight: 700;
  }

  tr.editing {
    background-color: #fff3cd !important;
  }

  tr.updated {
    background-color: #e7f6e7 !important;
    transition: background-color 1s ease;
  }

  .actions button {
    border: none;
    background: none;
    font-size: 18px;
    cursor: pointer;
    transition: transform 0.2s ease, opacity 0.2s ease;
  }
  .actions button:hover {
    transform: scale(1.2);
    opacity: 0.7;
  }

  .budget-card:nth-child(1),
  .detail-table:nth-of-type(1) h3 { background: var(--pastel-1); }

  .budget-card:nth-child(2),
  .detail-table:nth-of-type(2) h3 { background: var(--pastel-2); }

  .budget-card:nth-child(3),
  .detail-table:nth-of-type(3) h3 { background: var(--pastel-3); }

  .budget-card:nth-child(4),
  .detail-table:nth-of-type(4) h3 { background: var(--pastel-4); }

  .budget-card:nth-child(5),
  .detail-table:nth-of-type(5) h3 { background: var(--pastel-5); }

  .budget-card:nth-child(6),
  .detail-table:nth-of-type(6) h3 { background: var(--pastel-6); }

  .detail-table {
    display: none;
    margin-top: 40px;
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.12);
    overflow: hidden;
  }

  .detail-table h3 {
    color: #111;
    margin: 0;
    padding: 12px 18px;
    font-size: 18px;
    font-weight: 600;
  }

  .detail-table table {
    width: 100%;
    border-collapse: collapse;
  }

  .detail-table th, .detail-table td {
    border: 1px solid var(--border);
    padding: 8px 10px;
    text-align: center;
  }

  .detail-table th {
    background: #f5f5f5;
    font-weight: 600;
  }

  .detail-table tr:nth-child(even) td {
    background: #fafafa;
  }

  @media (max-width: 850px) {
    .cards-grid {
      flex-direction: column;
      gap: 15px;
    }
    .budget-card {
      flex: 1 1 100%;
    }
  }
</style>
{% endblock %}

<div class="wrap">
  <div class="page-header">
    <h2>üí∞ Pl√°novanie rozpoƒçtu</h2>
  </div>

  <div class="summary-box">
    <span>Zostatok celkom:</span>
    <strong id="zostatok" data-original="{{ zostatok }}">{{ "%.2f"|format(zostatok) }} ‚Ç¨</strong>
  </div>

  <div class="cards-grid" id="budget-cards">
    {% for item in data %}
    {% set name = item.b.section.value %}
    {% set percent = item.b.percent_target %}
    <div class="budget-card {{ name }}" data-name="{{ name }}">
      <div class="header">{{ name|replace('_',' ')|capitalize }}</div>
      <div class="content-row">
        <input type="number" class="percent-input" value="{{ "%.0f"|format(percent) }}" min="0" max="100">
        <span class="percent-symbol">%</span>
        <span class="amount" data-percent="{{ percent }}">0.00 ‚Ç¨</span>
      </div>
    </div>
    {% endfor %}
  </div>

  <div id="detail-tables">
    {% for table in table_meta %}
    <div class="detail-table" id="table-{{ table.name }}">
      <h3>{{ table.name|replace('_',' ')|capitalize }}</h3>
      <table>
        <thead>
        <tr>
          {% for col in table.columns if col != 'id' %}
          <th>{{ col|capitalize }}</th>
          {% endfor %}
          <th>Akcie</th>
        </tr>
        </thead>
        <tbody>
        {% for row in table.rows %}
        <tr data-id="{{ row.id }}">
          {% for col in table.columns if col != 'id' %}
          <td>{{ row[col] }}</td>
          {% endfor %}
          <td class="actions">
            <form method="post" action="{{ url_for('budgets.delete_record', table=table.name, row_id=row.id) }}" style="display:inline;">
              <button type="submit" title="Odstr√°ni≈•" class="delete-btn">üóëÔ∏è</button>
            </form>
            <form method="post" action="{{ url_for('budgets.edit_record', table=table.name, row_id=row.id) }}" style="display:inline;">
              <button type="button" class="edit-btn" title="Upravi≈•">‚úèÔ∏è</button>
            </form>
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>

      <form method="post" action="{{ url_for('budgets.add_record') }}" class="add-form">
        <input type="hidden" name="table" value="{{ table.name }}">
        {% for col in table.columns if col not in ['id'] %}
        <input type="text" name="{{ col }}" placeholder="{{ col|capitalize }}" required>
        {% endfor %}
        <button type="submit" class="add-btn">+ Prida≈• z√°znam</button>
      </form>
    </div>
    {% endfor %}
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const zostatokEl = document.getElementById("zostatok");
    const originalZostatok = parseFloat(zostatokEl.dataset.original);
    const cards = document.querySelectorAll(".budget-card");
    const tables = document.querySelectorAll(".detail-table");

    function recalc() {
      let remaining = originalZostatok;
      cards.forEach(card => {
        const percentInput = card.querySelector(".percent-input");
        const percent = parseFloat(percentInput.value) || 0;
        const amountEl = card.querySelector(".amount");
        const amount = (originalZostatok * percent / 100).toFixed(2);
        amountEl.textContent = `${amount} ‚Ç¨`;
        remaining -= amount;
      });
      zostatokEl.textContent = `${remaining.toFixed(2)} ‚Ç¨`;
    }


    function showTable(card) {
      const name = card.dataset.name;
      const color = window.getComputedStyle(card).backgroundColor;

      tables.forEach(t => {
        t.style.display = "none";
        t.style.opacity = 0;
      });

      cards.forEach(c => c.style.outline = "none");

      const selected = document.getElementById("table-" + name.toLowerCase());
      if (selected) {
        const header = selected.querySelector("h3");
        if (header) header.style.backgroundColor = color;

        selected.style.display = "block";
        selected.style.transition = "opacity 0.4s ease";
        requestAnimationFrame(() => selected.style.opacity = 1);

        card.style.outline = `3px solid ${color}`;
        card.style.outlineOffset = "2px";

        window.scrollTo({ top: selected.offsetTop - 60, behavior: "smooth" });
      }
    }

    cards.forEach(card => {
      const input = card.querySelector(".percent-input");
      input.addEventListener("input", recalc);

      card.addEventListener("click", () => showTable(card));
    });

    recalc();


    document.body.addEventListener("click", async (e) => {
      if (e.target.classList.contains("delete-btn")) {
        e.preventDefault();
        const form = e.target.closest("form");
        const row = form.closest("tr");
        const url = form.action;

        if (!confirm("Odstr√°ni≈• z√°znam?")) return;

        const res = await fetch(url, { method: "POST" });
        const data = await res.json();
        if (data.success) {
          row.style.transition = "opacity 0.3s ease";
          row.style.opacity = "0";
          setTimeout(() => row.remove(), 300);
        }
      }
    });

    document.body.addEventListener("click", (e) => {
      if (e.target.classList.contains("edit-btn")) {
        const row = e.target.closest("tr");
        const cells = row.querySelectorAll("td:not(.actions)");
        const saveBtn = document.createElement("button");
        saveBtn.textContent = "üíæ";
        saveBtn.classList.add("save-btn");

        if (row.classList.contains("editing")) return;
        row.classList.add("editing");
        row.style.backgroundColor = "#fff3cd";

        cells.forEach(td => {
          const oldText = td.textContent.trim();
          td.innerHTML = `<input type="text" value="${oldText}" style="width:90%">`;
        });

        const actionsCell = row.querySelector(".actions");
        actionsCell.innerHTML = "";
        actionsCell.appendChild(saveBtn);
      }
    });


    document.body.addEventListener("click", async (e) => {
      if (e.target.classList.contains("save-btn")) {
        const row = e.target.closest("tr");
        const tableDiv = e.target.closest(".detail-table");
        const tableName = tableDiv.id.replace("table-", "");
        const rowId = row.dataset.id;

        const inputs = row.querySelectorAll("td:not(.actions) input");
        const payload = {};
        inputs.forEach((input, idx) => {
          const colName = tableDiv.querySelectorAll("th")[idx].textContent.toLowerCase();
          payload[colName] = input.value;
        });

        const res = await fetch(`/budgets/edit/${tableName}/${rowId}`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
          row.classList.remove("editing");
          row.style.backgroundColor = "#e7f6e7";
          row.innerHTML = "";
          Object.values(payload).forEach(val => {
            const td = document.createElement("td");
            td.textContent = val;
            row.appendChild(td);
          });
          const actions = document.createElement("td");
          actions.classList.add("actions");
          actions.innerHTML = `
          <button class="edit-btn" title="Upravi≈•">‚úèÔ∏è</button>
          <button class="delete-btn" title="Odstr√°ni≈•">üóëÔ∏è</button>`;
          row.appendChild(actions);
        }
      }
    });

  });
</script>
{% endblock %}
