{
  "openapi": "3.0.0",
  "info": {
    "title": "API Dokumentácia – Príjmy a Výdavky",
    "version": "1.0.0",
    "description": "Rozhranie pre prácu s príjmami (Incomes) a výdavkami (Receipts & Receipt Items)."
  },
  "servers": [
    { "url": "/" }
  ],
  "paths": {
    "/api/users": {
      "get": {
        "summary": "Získanie zoznamu používateľov",
        "responses": {
          "200": {
            "description": "Úspešne načítaní používatelia",
            "content": {
              "application/json": {
                "example": [
                  {
                    "id": "78754f0f-e6ed-4a10-a09a-26da4cb2a5f6",
                    "username": "anton",
                    "email": "anton@example.com",
                    "created_at": "2025-10-27T15:30:00Z"
                  }
                ]
              }
            }
          }
        }
      },
      "post": {
        "summary": "Vytvorenie nového používateľa",
        "description": "Vytvorí nového používateľa systému.\n\n**Povinné polia:** `username`, `email`, `password_hash`\n\n**Nepovinné polia:** žiadne (všetky ostatné sú generované automaticky – `id`, `created_at`).",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "example": {
                "username": "anton",
                "email": "anton@example.com",
                "password_hash": "pbkdf2:sha256:260000$..."
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Používateľ úspešne vytvorený",
            "content": {
              "application/json": {
                "example": {
                  "id": "78754f0f-e6ed-4a10-a09a-26da4cb2a5f6",
                  "message": "User created successfully"
                }
              }
            }
          },
          "400": {
            "description": "Neplatné dáta – chýbajú povinné polia",
            "content": {
              "application/json": {
                "example": { "error": "Missing required fields" }
              }
            }
          }
        }
      }
    },

    "/api/receipts": {
      "get": {
        "summary": "Získanie zoznamu všetkých účteniek",
        "responses": {
          "200": {
            "description": "Úspešne načítané účtenky",
            "content": {
              "application/json": {
                "example": [
                  {
                    "id": "c0e4f248-f14d-4f53-b92c-9f5ecb8239d4",
                    "external_uid": "INV-2025-00012",
                    "tag": "Groceries",
                    "tag_id": "12c23b3e-8fab-4df7-95dc-8a3e3d79c9f1",
                    "description": "Lidl - potraviny",
                    "issue_date": "2025-10-27",
                    "currency": "EUR",
                    "total_amount": 45.20,
                    "extra_metadata": {
                      "payment_method": "card",
                      "vat": 7.5
                    },
                    "user_id": "78754f0f-e6ed-4a10-a09a-26da4cb2a5f6",
                    "created_at": "2025-10-27T19:00:00Z"
                  }
                ]
              }
            }
          }
        }
      },
      "post": {
        "summary": "Vytvorenie novej účtenky",
        "description": "Vytvorí novú účtenku (receipt) priradenú k existujúcemu používateľovi.\n\n**Povinné polia:** `user_id`, `description`\n\n**Nepovinné polia:** `issue_date`, `currency` (predvolené `EUR`), `total_amount` (predvolené `0.0`), `tag_id` (musí patriť tomu istému používateľovi), `external_uid`, `extra_metadata`.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "example": {
                "user_id": "78754f0f-e6ed-4a10-a09a-26da4cb2a5f6",
                "description": "Lidl - týždenný nákup",
                "issue_date": "2025-10-27",
                "currency": "EUR",
                "total_amount": 45.20,
                "tag_id": "12c23b3e-8fab-4df7-95dc-8a3e3d79c9f1",
                "external_uid": "INV-2025-00012",
                "extra_metadata": {
                  "payment_method": "card",
                  "vat": 7.5,
                  "cashier": "Marek",
                  "location": "Bratislava"
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Úspešne vytvorená účtenka",
            "content": {
              "application/json": {
                "example": {
                  "id": "c0e4f248-f14d-4f53-b92c-9f5ecb8239d4",
                  "message": "Receipt created successfully"
                }
              }
            }
          },
          "400": {
            "description": "Chybná požiadavka – chýbajú povinné polia alebo zlé formáty dát",
            "content": {
              "application/json": {
                "examples": {
                  "missing_body": {
                    "summary": "Chýbajúce telo požiadavky",
                    "value": { "error": "Missing JSON body" }
                  },
                  "validation_error": {
                    "summary": "Chyba validácie",
                    "value": {
                      "error": "Missing user_id"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },

    "/api/receipts/{receipt_id}": {
      "get": {
        "summary": "Získanie detailu účtenky podľa ID",
        "parameters": [
          {
            "in": "path",
            "name": "receipt_id",
            "required": true,
            "schema": { "type": "string", "format": "uuid" },
            "description": "UUID účtenky"
          }
        ],
        "responses": {
          "200": {
            "description": "Úspešne načítaná účtenka",
            "content": {
              "application/json": {
                "example": {
                  "id": "c0e4f248-f14d-4f53-b92c-9f5ecb8239d4",
                  "external_uid": "INV-2025-00012",
                  "tag": "Groceries",
                  "tag_id": "12c23b3e-8fab-4df7-95dc-8a3e3d79c9f1",
                  "description": "Lidl - potraviny",
                  "issue_date": "2025-10-27",
                  "currency": "EUR",
                  "total_amount": 45.20,
                  "extra_metadata": {
                    "payment_method": "card",
                    "vat": 7.5
                  },
                  "user_id": "78754f0f-e6ed-4a10-a09a-26da4cb2a5f6",
                  "created_at": "2025-10-27T19:00:00Z"
                }
              }
            }
          },
          "404": {
            "description": "Účtenka nebola nájdená",
            "content": {
              "application/json": {
                "example": { "error": "Receipt not found" }
              }
            }
          }
        }
      },
      "put": {
        "summary": "Aktualizácia existujúcej účtenky",
        "description": "Aktualizuje záznam účtenky podľa ID.\n\n**Nepovinné polia:** `description`, `issue_date`, `currency`, `total_amount`, `tag_id` (null = odpojiť tag), `external_uid`, `extra_metadata`.",
        "parameters": [
          {
            "in": "path",
            "name": "receipt_id",
            "required": true,
            "schema": { "type": "string", "format": "uuid" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "example": {
                "description": "Tesco - týždenný nákup",
                "issue_date": "2025-10-29",
                "currency": "EUR",
                "total_amount": 60.50,
                "tag_id": "12c23b3e-8fab-4df7-95dc-8a3e3d79c9f1",
                "external_uid": "INV-2025-00013",
                "extra_metadata": {
                  "payment_method": "cash",
                  "vat": 9.5,
                  "cashier": "Mária"
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Úspešne aktualizovaná účtenka",
            "content": {
              "application/json": {
                "example": {
                  "id": "c0e4f248-f14d-4f53-b92c-9f5ecb8239d4",
                  "message": "Receipt updated successfully"
                }
              }
            }
          },
          "400": {
            "description": "Neplatné dáta alebo formát dátumu",
            "content": {
              "application/json": {
                "examples": {
                  "empty_description": {
                    "summary": "Prázdny popis",
                    "value": { "error": "Description cannot be empty" }
                  },
                  "invalid_date": {
                    "summary": "Neplatný formát dátumu",
                    "value": { "error": "Invalid issue_date format, expected YYYY-MM-DD" }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Účtenka nebola nájdená",
            "content": {
              "application/json": {
                "example": { "error": "Receipt not found" }
              }
            }
          }
        }
      },
      "delete": {
        "summary": "Odstránenie účtenky podľa ID",
        "parameters": [
          {
            "in": "path",
            "name": "receipt_id",
            "required": true,
            "schema": { "type": "string", "format": "uuid" }
          }
        ],
        "responses": {
          "200": {
            "description": "Účtenka bola úspešne odstránená",
            "content": {
              "application/json": {
                "example": { "message": "Receipt deleted successfully" }
              }
            }
          },
          "404": {
            "description": "Účtenka nebola nájdená",
            "content": {
              "application/json": {
                "example": { "error": "Receipt not found" }
              }
            }
          }
        }
      }
    },

    "/api/receipts/import-ekasa": {
      "post": {
        "summary": "Import účtenky z eKasa systému",
        "description": "Na základe `receiptId` z eKasa API načíta údaje o účtenke a uloží ich do lokálnej databázy pod daného používateľa.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "example": {
                "receiptId": "1234567890ABCDEF",
                "user_id": "78754f0f-e6ed-4a10-a09a-26da4cb2a5f6"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Úspešne importovaná účtenka",
            "content": {
              "application/json": {
                "example": {
                  "message": "Receipt imported successfully",
                  "tag": "Lidl - potraviny",
                  "tag_id": "12c23b3e-8fab-4df7-95dc-8a3e3d79c9f1",
                  "receipt_id": "c0e4f248-f14d-4f53-b92c-9f5ecb8239d4",
                  "total_items": 5
                }
              }
            }
          },
          "400": {
            "description": "Chyba pri volaní eKasa API alebo validácii vstupov",
            "content": {
              "application/json": {
                "examples": {
                  "missing_fields": {
                    "summary": "Chýbajúce polia",
                    "value": {
                      "code": "bad_request",
                      "message": "Missing receiptId or user_id"
                    }
                  },
                  "ekasa_error": {
                    "summary": "Chyba eKasa / importu",
                    "value": {
                      "code": "ekasa_error",
                      "message": "Import failed: ...",
                      "details": {
                        "error": "Import failed: (sqlite3.OperationalError) ..."
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },

    "/api/receipts/{receipt_id}/items": {
      "get": {
        "summary": "Získanie všetkých položiek účtenky",
        "parameters": [
          {
            "in": "path",
            "name": "receipt_id",
            "required": true,
            "schema": { "type": "string", "format": "uuid" },
            "description": "UUID účtenky"
          }
        ],
        "responses": {
          "200": {
            "description": "Úspešne načítané položky",
            "content": {
              "application/json": {
                "example": [
                  {
                    "id": "dfcd4441-8a3a-4d62-bac9-2eb7a6dbb2e9",
                    "name": "Mlieko",
                    "quantity": 2,
                    "unit_price": 1.2,
                    "total_price": 2.4
                  }
                ]
              }
            }
          },
          "404": {
            "description": "Účtenka nebola nájdená",
            "content": {
              "application/json": {
                "example": { "error": "Receipt not found" }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Vytvorenie položky pre účtenku",
        "description": "**Povinné polia:** `name`, `quantity`, `unit_price`.\n\n**Nepovinné:** `category_id`, `extra_metadata`.",
        "parameters": [
          {
            "in": "path",
            "name": "receipt_id",
            "required": true,
            "schema": { "type": "string", "format": "uuid" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "example": {
                "category_id": "a3f84b9a-42cc-4ef9-9f1d-84e7e3e2d56d",
                "name": "Banány",
                "quantity": 3,
                "unit_price": 0.9,
                "extra_metadata": { "discount": 0.1 }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Položka úspešne pridaná",
            "content": {
              "application/json": {
                "example": {
                  "item_id": "7a05d2e9-2b9f-4f26-bb3b-6b0b6a6d2f98",
                  "message": "Item created successfully"
                }
              }
            }
          }
        }
      }
    },

    "/api/receipts/{receipt_id}/items/{item_id}": {
      "put": {
        "summary": "Aktualizácia položky účtenky",
        "parameters": [
          { "in": "path", "name": "receipt_id", "required": true, "schema": { "type": "string", "format": "uuid" } },
          { "in": "path", "name": "item_id", "required": true, "schema": { "type": "string", "format": "uuid" } }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "example": {
                "name": "Maslo",
                "quantity": 1,
                "unit_price": 2.3,
                "extra_metadata": { "promo": true }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Úspešne aktualizované",
            "content": {
              "application/json": {
                "example": { "message": "Item updated successfully" }
              }
            }
          },
          "404": {
            "description": "Položka nebola nájdená",
            "content": {
              "application/json": {
                "example": { "error": "Item not found" }
              }
            }
          }
        }
      },
      "delete": {
        "summary": "Odstránenie položky účtenky",
        "parameters": [
          { "in": "path", "name": "receipt_id", "required": true, "schema": { "type": "string", "format": "uuid" } },
          { "in": "path", "name": "item_id", "required": true, "schema": { "type": "string", "format": "uuid" } }
        ],
        "responses": {
          "200": {
            "description": "Položka úspešne vymazaná",
            "content": {
              "application/json": {
                "example": { "message": "Item deleted successfully" }
              }
            }
          },
          "404": {
            "description": "Položka nebola nájdená",
            "content": {
              "application/json": {
                "example": { "error": "Item not found" }
              }
            }
          }
        }
      }
    },

    "/api/incomes/": {
      "get": {
        "summary": "Získanie zoznamu všetkých príjmov",
        "description": "Vráti zoznam všetkých príjmov vrátane celkovej sumy. Možno použiť voliteľné parametre na triedenie podľa dátumu alebo sumy.",
        "parameters": [
          {
            "in": "query",
            "name": "sort",
            "schema": { "type": "string", "enum": ["income_date", "amount"], "default": "income_date" },
            "description": "Triedenie podľa poľa (income_date alebo amount)"
          },
          {
            "in": "query",
            "name": "order",
            "schema": { "type": "string", "enum": ["asc", "desc"], "default": "desc" },
            "description": "Poradie triedenia – vzostupne alebo zostupne"
          }
        ],
        "responses": {
          "200": {
            "description": "Úspešne načítané",
            "content": {
              "application/json": {
                "example": {
                  "success": true,
                  "incomes": [
                    {
                      "id": "b1a4a77d-2ac9-4e1f-bb28-894f51d4a6c9",
                      "user_id": "78754f0f-e6ed-4a10-a09a-26da4cb2a5f6",
                      "tag": "Salary",
                      "tag_id": "aa5f9e12-5b74-4d0e-aeb8-8a3e8a3be111",
                      "description": "Výplata",
                      "amount": 1200.00,
                      "income_date": "2025-10-01",
                      "extra_metadata": null
                    },
                    {
                      "id": "d4c2f11e-89ab-4cbb-9e12-1f2d6f8e1b2a",
                      "user_id": "78754f0f-e6ed-4a10-a09a-26da4cb2a5f6",
                      "tag": null,
                      "tag_id": null,
                      "description": "Darček od babky",
                      "amount": 200.00,
                      "income_date": "2025-10-05",
                      "extra_metadata": null
                    }
                  ],
                  "total_amount": 1400.00
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Vytvorenie nového príjmu",
        "description": "Pridá nový záznam o príjme s dátumom, popisom a sumou.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "example": {
                "user_id": "78754f0f-e6ed-4a10-a09a-26da4cb2a5f6",
                "income_date": "2025-10-15",
                "description": "Freelance projekt",
                "amount": 500.00,
                "tag_id": "aa5f9e12-5b74-4d0e-aeb8-8a3e8a3be111",
                "extra_metadata": {
                  "project": "ML model",
                  "client": "ABC Corp"
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Úspešne vytvorený príjem",
            "content": {
              "application/json": {
                "example": {
                  "id": "e7d4a5b2-3c1a-4d33-9182-0f3a9b1c2d4e",
                  "message": "Income created successfully"
                }
              }
            }
          },
          "400": {
            "description": "Neplatné vstupné dáta",
            "content": {
              "application/json": {
                "examples": {
                  "missing_description": {
                    "summary": "Chýbajúci popis",
                    "value": { "error": "Missing description" }
                  },
                  "invalid_tag": {
                    "summary": "Tag neexistuje alebo nepatrí používateľovi",
                    "value": { "error": "Tag does not belong to this user" }
                  },
                  "invalid_format": {
                    "summary": "Neplatný formát UUID/dát",
                    "value": { "error": "Invalid data format: ..." }
                  }
                }
              }
            }
          }
        }
      }
    },

    "/api/incomes/{income_id}": {
      "get": {
        "summary": "Získanie detailu príjmu podľa ID",
        "parameters": [
          {
            "in": "path",
            "name": "income_id",
            "required": true,
            "schema": { "type": "string", "format": "uuid" },
            "description": "UUID príjmu"
          }
        ],
        "responses": {
          "200": {
            "description": "Úspešne načítaný príjem",
            "content": {
              "application/json": {
                "example": {
                  "id": "b1a4a77d-2ac9-4e1f-bb28-894f51d4a6c9",
                  "user_id": "78754f0f-e6ed-4a10-a09a-26da4cb2a5f6",
                  "tag": "Salary",
                  "tag_id": "aa5f9e12-5b74-4d0e-aeb8-8a3e8a3be111",
                  "description": "Výplata",
                  "amount": 1200.00,
                  "income_date": "2025-10-01",
                  "extra_metadata": null
                }
              }
            }
          },
          "404": {
            "description": "Príjem nebol nájdený",
            "content": {
              "application/json": {
                "example": { "error": "Income not found" }
              }
            }
          }
        }
      },
      "put": {
        "summary": "Aktualizácia existujúceho príjmu",
        "parameters": [
          {
            "in": "path",
            "name": "income_id",
            "required": true,
            "schema": { "type": "string", "format": "uuid" },
            "description": "UUID príjmu, ktorý sa má aktualizovať"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "example": {
                "income_date": "2025-10-16",
                "description": "Zmenený popis",
                "amount": 600.00,
                "tag_id": "aa5f9e12-5b74-4d0e-aeb8-8a3e8a3be111",
                "extra_metadata": {
                  "note": "upravené po revízii"
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Úspešne aktualizované",
            "content": {
              "application/json": {
                "example": {
                  "id": "b1a4a77d-2ac9-4e1f-bb28-894f51d4a6c9",
                  "message": "Income updated successfully"
                }
              }
            }
          },
          "400": {
            "description": "Neplatné vstupné dáta",
            "content": {
              "application/json": {
                "examples": {
                  "empty_description": {
                    "summary": "Prázdny popis",
                    "value": { "error": "Description cannot be empty" }
                  },
                  "invalid_tag": {
                    "summary": "Neplatný tag",
                    "value": { "error": "Tag not found" }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Príjem nebol nájdený",
            "content": {
              "application/json": {
                "example": { "error": "Income not found" }
              }
            }
          }
        }
      },
      "delete": {
        "summary": "Odstránenie existujúceho príjmu",
        "parameters": [
          {
            "in": "path",
            "name": "income_id",
            "required": true,
            "schema": { "type": "string", "format": "uuid" },
            "description": "UUID príjmu, ktorý sa má odstrániť"
          }
        ],
        "responses": {
          "200": {
            "description": "Úspešne odstránené",
            "content": {
              "application/json": {
                "example": { "message": "Income deleted successfully" }
              }
            }
          },
          "404": {
            "description": "Príjem nebol nájdený",
            "content": {
              "application/json": {
                "example": { "error": "Income not found" }
              }
            }
          }
        }
      }
    }
  }
}
